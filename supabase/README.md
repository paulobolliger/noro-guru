Supabase Migrations — Project Guide

Purpose

- Keep local migrations in sync with the remote database so `supabase db pull/push` work reliably.
- Document what is baseline vs. incremental changes and how to add new DDL.

Folder Structure

- `supabase/migrations/` — Active migration files tracked by Supabase CLI.
- `supabase/migrations/_archive/` — SQL that was applied manually (SQL editor) or is not part of the CLI history. Do not keep these in the root migrations folder.
- `supabase/schema_snapshots/` — CSV/exports used for analysis only (never treated as migrations).

Current Baseline

- The repo includes a fresh baseline snapshot generated by `supabase db pull`:
  - Example: `20251028133307_remote_schema.sql`
- This file reflects the remote database state after we reconciled history.

Workflow (Add/Change Schema)

1) Create a new migration
   - `supabase migration new <short-name>`
2) Edit the generated file
   - Use defensive DDL where sensible: `CREATE ... IF NOT EXISTS`, `DROP ... IF EXISTS`.
   - Order: schemas → tables → indexes → views → functions → policies → grants.
3) Apply to remote
   - `supabase db push`
4) Verify
   - `supabase db pull` should be clean (no mismatches).

Do / Don’t

- Do apply all schema changes via migrations and `db push`.
- Don’t keep CSV or ad‑hoc SQL in `supabase/migrations/` (use `schema_snapshots/` or `_archive/`).
- Don’t re‑run old “baseline” dumps manually; treat them as history only.

Repairing History (only if prompted)

- If CLI shows: "The remote database's migration history does not match local files":
  - Prefer reconciling by archiving extra local files and regenerating a fresh baseline with `supabase db pull`.
  - As a last resort, use: `supabase migration repair --status reverted <version>` per the CLI hint.

Seeds

- Use a dedicated migration for seeds that are safe to re‑apply (`INSERT ... ON CONFLICT DO NOTHING`).
- Avoid direct inserts via SQL editor for objects that must be tracked.

RLS & Grants

- Enable RLS explicitly on new tables and add policies that reference tenant membership.
- Keep `GRANT` statements minimal and consistent with policies.

Troubleshooting

- Pooler/auth prompts: ensure you ran `supabase link --project-ref <ref>` and are logged in.
- CSV in migrations: move to `schema_snapshots/`.
- Duplicate object errors on local dev: add `IF NOT EXISTS`/`IF EXISTS` to older DDL if you need to replay locally.

