                          ğŸŒ Cloudflare (DNS + Tunnel + Zero Trust)
                                           â”‚
                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Control Plane â†’  https://control.noro.guru          â”‚
â”‚  (Next.js + Supabase + RPC + Realtime)                                 â”‚
â”‚                                                                        â”‚
â”‚  â€¢ cp schema: tenants, users, billing, logs, events, email_logs        â”‚
â”‚  â€¢ Orquestra via n8n â†’ provisiona tenants, ERP, CRM, Mautic            â”‚
â”‚  â€¢ PainÃ©is globais (/control/dashboard, /billing, /logs...)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                            â”‚
               â”‚ REST/RPC (Supabase)        â”‚ Workflows (n8n)
               â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Supabase (Free Tier)  â”‚       â”‚  Oracle Cloud VM #2       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚  n8n + Traefik + Caddy    â”‚
â”‚ cp.*  (global)            â”‚â—„â”€â”€â”€â”€â”€â”€â”¤ Orquestrador / Provision  â”‚
â”‚ tenant_* (por cliente)    â”‚       â”‚ Workflows: create_tenant, â”‚
â”‚ Auth / Storage / RPCs     â”‚       â”‚ send_email, billing_sync  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–²                            â”‚
               â”‚                            â”‚ Docker API (local)
               â”‚                            â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚             Oracle Cloud VM #1               â”‚
                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
                        â”‚  Containers por Tenant:                      â”‚
                        â”‚   - ERP (Dolibarr PHP + MariaDB)             â”‚
                        â”‚   - CRM (EspoCRM PHP + MariaDB)              â”‚
                        â”‚   - Mautic (PHP + MariaDB)                   â”‚
                        â”‚  Todos rodando headless, acessados via APIs  â”‚
                        â”‚  Internos: erp.t-<slug>.svc.local            â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
                                        â˜ï¸  AWS SES (Email Hub)
                                        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                        â€¢ Um serviÃ§o central
                                        â€¢ DomÃ­nios verificados: nomade.guru, vistos.guru, etc.
                                        â€¢ Configuration Set = slug do tenant
                                        â€¢ n8n envia via API SES
                                        â€¢ Logs â†’ cp.email_logs (Supabase)

---

## ğŸ§© 2. Fluxos principais

### ğŸ”¹ 1) CriaÃ§Ã£o de Tenant
1. Admin cria tenant no `/control/tenants`.
2. Supabase insere registro em `cp.tenants`.
3. Trigger chama webhook n8n: **create_tenant**.
4. n8n:
   - Cria schema `tenant_<slug>` no Supabase.
   - Sobe containers (ERP/CRM/Mautic) + DBs no Oracle VM #1.
   - Registra os serviÃ§os e endpoints.
   - Atualiza `cp.system_events` â†’ status = UP.

---

### ğŸ”¹ 2) Envio de E-mails (Centralizado no SES)
1. Algum mÃ³dulo (Core ou Control) publica evento `send_email`.
2. n8n consome â†’ identifica `tenant_id`.
3. Busca domÃ­nio verificado em `cp.ses_identities`.
4. Chama **AWS SES API** com `ConfigurationSet = tenant_slug`.
5. SES entrega e-mail; callback via EventBridge â†’ n8n â†’ Supabase (`cp.email_logs`).

---

### ğŸ”¹ 3) Core App (Tenant Runtime)
Cada tenant acessa:
https://noro.guru/t/<slug>

- Autentica no Supabase (schema do tenant).
- Consome APIs headless do ERP/CRM/Mautic via **n8n Gateway interno**.
- Dados de cliente, pedidos, leads, campanhas â†’ armazenados em `tenant_<slug>.*`.

---

### ğŸ”¹ 4) Billing / RelatÃ³rios
- Supabase executa `cp_dashboard_overview()` para consolidar KPIs.
- n8n agrega volume de e-mails (SES) + uso de containers.
- `/control/billing` mostra plano, limites e eventos de cobranÃ§a.
- Pagamentos processados via Cielo/Stripe (plug-in).

---

## âš™ï¸ 3. Componentes TÃ©cnicos

| Camada | Tecnologia | Free Tier Status | FunÃ§Ã£o na Arquitetura |
|--------|-------------|-----------------|-----------------------|
| **Infra Core** | Oracle Cloud VM (Ampere A1 1 vCPU / 1 GB) | âœ… Always Free | Containers headless (ERP/CRM/Mautic) + MariaDB |
| **OrquestraÃ§Ã£o** | Oracle Cloud VM #2 (n8n + Traefik + Caddy) | âœ… | Controla playbooks e roteamento |
| **Banco central** | Supabase (Postgres) | âœ… | Schemas cp e tenant_* + auth + storage + RPC |
| **Frontend** | Next.js 14 (Vercel ou VM) | âœ… (se Vercel Free) | Control Plane + Core Apps |
| **E-mail** | AWS SES | ğŸ’° BaixÃ­ssimo (â‰ˆ US$ 0.10/1 000 emails) | Hub multi-tenant de envio |
| **DNS/TÃºnel** | Cloudflare | âœ… | DNS, SSL, Access, Tunnel, WAF |
| **Logs/Metrics** | cp.system_events / cp.admin_logs | âœ… | Auditoria global e monitoramento |

---

## ğŸ—ï¸ 4. Estrutura de dados chave no Supabase

**Schemas**
- `cp.*` â†’ Controle global.
- `tenant_<slug>.*` â†’ Dados isolados de cada cliente.

**Tabelas principais (cp)**
- `cp.tenants` â€“ registro e status dos tenants  
- `cp.ses_identities` â€“ domÃ­nios verificados no SES  
- `cp.system_events` â€“ eventos de infra (provision, status)  
- `cp.email_logs` â€“ envios e mÃ©tricas de e-mail  
- `cp.billing_events` â€“ consumo e faturamento  

---

## ğŸ§  5. Rede & SeguranÃ§a

- ğŸ”’ **Todos os containers** (ERP/CRM/Mautic) vivem em rede privada (`*.svc.local`).
- ğŸŒ©ï¸ **Cloudflare Tunnel** liga o Control Plane ao n8n/Traefik.
- ğŸ§‘â€ğŸ’» **Cloudflare Access (Zero Trust)** protege interfaces admin.
- ğŸ”‘ Secrets (AWS Keys, DB creds) guardados no Supabase Vault ou .env criptografado.
- ğŸ”„ n8n gera tokens de serviÃ§o curtos para cada tenant em runtime.

---

## ğŸ’° 6. Custo estimado (mÃªs)

| ServiÃ§o | Custo | ObservaÃ§Ãµes |
|----------|--------|-------------|
| Oracle 2 VMs | **US$ 0,00** | Always Free |
| Supabase | **US$ 0,00** | 500 MB storage |
| AWS SES | **â‰ˆ US$ 10,00** | 100 mil e-mails/mÃªs |
| Vercel Frontend | **US$ 0,00** | Free Hobby |
| Cloudflare | **US$ 0,00** | Free Plan |
| **Total** | **â‰ˆ US$ 10,00/mÃªs** | operaÃ§Ã£o multi-tenant completa |

---

## ğŸ”® 7. Futuro imediato

- ğŸ” Automatizar **scale-to-zero** dos containers inativos (via n8n).  
- ğŸ“ˆ Adicionar **Grafana/Metabase** (render.com free) para dashboards.  
- ğŸ“¬ Conectar **AWS EventBridge â†’ n8n** para telemetria de entrega de e-mails.  
- ğŸª„ Provisionamento â€œone-clickâ€ de tenant dentro do Control Plane.  
- ğŸ’³ IntegraÃ§Ã£o de billing real com Stripe/Cielo via Supabase Functions.

---

## ğŸ§© 8. Diagrama resumido

        +----------------------+
        |    control.noro.guru |
        |   (Next.js + Supa)   |
        +----------+-----------+
                   |
                   | RPC / Events
                   â–¼
    +-----------------------------+
    |        Supabase DB          |
    |  cp.* & tenant_* schemas    |
    +-------------+---------------+
                  |
                  | Webhooks / API
                  â–¼
     +-----------------------------+
     |  Oracle VM #2 â€“ n8n/Traefik |
     +-------------+---------------+
                   |
                   | Docker API
                   â–¼
     +-----------------------------+
     | Oracle VM #1 â€“ Containers   |
     | ERP / CRM / Mautic          |
     +-------------+---------------+
                   |
                   | SMTP / API
                   â–¼
           +----------------+
           |  AWS SES       |
           +----------------+
                   |
                   â–¼
           ğŸŒ Cloudflare DNS/Tunnel


---

ğŸ‘‰ **Resumo executivo**

- **Infra gratuita**: Oracle (2 VMs) + Supabase + Cloudflare + Vercel.  
- **Custo controlado**: apenas SES (~US$ 10/mÃªs).  
- **Headless total**: tudo via API, sem UI exposta.  
- **Control Plane**: gestÃ£o global (provision, billing, logs).  
- **Core/Tenants**: isolados por schema e containers.  
- **Escalabilidade futura**: plug-and-play para AWS, Fly.io ou Kubernetes.

---

Quer que eu monte **o blueprint de provisionamento completo** (playbook do n8n + estrutura de pastas e nomes de containers + variÃ¡veis .env necessÃ¡rias) para vocÃª rodar isso de ponta a ponta?

noro-guru/
â”œâ”€â”€ infra/
â”‚   â”œâ”€â”€ docker/
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml     â† containers ERP/CRM/Mautic
â”‚   â”‚   â”œâ”€â”€ traefik.yml            â† proxy reverso + SSL interno
â”‚   â”‚   â””â”€â”€ .env                   â† variÃ¡veis da VM
â”‚   â”œâ”€â”€ n8n/
â”‚   â”‚   â”œâ”€â”€ workflows/             â† fluxos provisionar, enviar email, billing
â”‚   â”‚   â””â”€â”€ .env
â”‚   â”œâ”€â”€ provision/
â”‚   â”‚   â”œâ”€â”€ provision-tenant.ts    â† script Supabase + API + n8n
â”‚   â”‚   â”œâ”€â”€ create-tenant-schema.sql
â”‚   â”‚   â””â”€â”€ update-tenant-status.sql
â”‚   â”œâ”€â”€ sql/
â”‚   â”‚   â”œâ”€â”€ cp_tenants.sql
â”‚   â”‚   â”œâ”€â”€ cp_dashboard_overview.sql
â”‚   â”‚   â”œâ”€â”€ cp_email_logs.sql
â”‚   â”‚   â””â”€â”€ cp_system_events.sql
â”‚   â””â”€â”€ docs/
â”‚       â”œâ”€â”€ INSTALL_ORACLE_VM.md
â”‚       â”œâ”€â”€ INSTALL_AWS_SES.md
â”‚       â””â”€â”€ INSTALL_SUPABASE.md
â””â”€â”€ app/
    â””â”€â”€ control/ ... (jÃ¡ existe)


#ENV GLOBAL

# ğŸ”¹ Supabase
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=xxxxxxxxx
SUPABASE_SERVICE_KEY=xxxxxxxxx

# ğŸ”¹ AWS SES
AWS_ACCESS_KEY_ID=AKIAxxxxxxx
AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxx
AWS_REGION=us-east-1
SES_DEFAULT_SENDER=no-reply@noro.guru

# ğŸ”¹ Oracle VM
ORACLE_VM1_IP=10.0.0.5
ORACLE_VM2_IP=10.0.0.6
ORACLE_USER=ubuntu

# ğŸ”¹ n8n
N8N_URL=https://n8n.noro.guru
N8N_API_KEY=xxxxxxxxx

# ğŸ”¹ Control Plane
CONTROL_URL=https://control.noro.guru

# ğŸ”¹ Cloudflare
CLOUDFLARE_API_TOKEN=xxxxxxxxx
CLOUDFLARE_ACCOUNT_ID=xxxxxxxxx
CLOUDFLARE_ZONE_ID=xxxxxxxxx
